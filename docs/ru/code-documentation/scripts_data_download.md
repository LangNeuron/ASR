# Документация scripts/data_download

## Назначение
`bash scripts/data_download.sh` скачивает выбранные ASR-датасеты в `data/raw`, распаковывает архивы и считает статистику:
- количество аудиофайлов по каждому набору;
- оценка часов по каждому набору;
- общий итог по файлам и часам.

Скрипт `scripts/data_download.sh` является оболочкой для `scripts/data_download.py`.

## Источники данных
Встроенные скачиваемые источники:
- Golos Opus
- OpenSTT `asr_public_phone_calls_2` (архив + манифест)
- OpenSTT `public_youtube1120` (архив + манифест)

Опциональные источники:
- Mozilla/Common Voice архив через `--mozilla-url` (скачивание по URL)
- SOVA/RuDevices через `--sova-archive` (путь к локальному архиву)

Для SOVA архив нужно скачать вручную отсюда:
- `https://disk.yandex.ru/d/jz3k7pnzTpnTgw`

## Расположение данных
Данные сохраняются в `data/raw`:
- `data/raw/golos_opus/`
- `data/raw/open_stt/asr_public_phone_calls_2/`
- `data/raw/open_stt/public_youtube1120/`
- `data/raw/mozilla_voice_custom/` (только если указан `--mozilla-url`)
- `data/raw/sova_rudevices/` (только если указан `--sova-archive`)

## CLI
```bash
bash scripts/data_download.sh [command] [options]
```

Команды:
- `download` (по умолчанию)
  Скачивает отсутствующие данные, проверяет уже скачанные архивы по размеру, продолжает прерванные загрузки.
- `reinstall-all`
  Принудительно перескачивает встроенные скачиваемые датасеты и переустанавливает опциональные входы.

Аргументы:
- `--raw-dir PATH`
  Изменить целевую директорию (по умолчанию: `data/raw`).
- `--datasets {golos,openstt_phone,openstt_youtube,all} ...`
  Выбор встроенных скачиваемых наборов данных. По умолчанию: `all`.
- `--mozilla-url URL`
  Опциональная пользовательская ссылка на Mozilla/Common Voice архив.
  Если параметр задан, Mozilla будет скачан, даже если его нет в `--datasets`.
- `--sova-archive PATH`
  Путь к уже скачанному локальному SOVA-архиву (`RuDevices.tar`).
- `--no-extract`
  Только скачать/скопировать архивы, без распаковки.

## Политика повторных попыток
Скрипт использует 3 уровня повторов:
- Локальные повторы запроса: `5` попыток для отдельной передачи файла.
- Повторы на датасет: `3` попытки на пайплайн конкретного датасета.
- Глобальные повторы: `5` попыток на полный выбранный пайплайн загрузки.

## Поведение загрузки
- Если архив уже скачан и его локальный размер совпадает с удаленным, скачивание пропускается.
- Если архив скачан частично, скрипт пытается продолжить загрузку через HTTP Range.
- Если сервер не поддерживает продолжение, файл перескачивается с нуля.
- Если на распаковке найден поврежденный архив, скрипт перескачивает архив и повторяет распаковку.
- После успешной распаковки `.tar` / `.tar.gz` архив удаляется для экономии места.
- Разархивированные датасеты отмечаются и автоопределяются, чтобы при повторном запуске не скачивать заново.

## Примеры
Скачать все встроенные скачиваемые наборы:
```bash
bash scripts/data_download.sh
```

Установить SOVA из локального архива:
```bash
bash scripts/data_download.sh --sova-archive /path/to/RuDevices.tar
```

Использовать локальный SOVA + встроенные скачивания:
```bash
bash scripts/data_download.sh --datasets all --sova-archive /path/to/RuDevices.tar
```

Продолжить ранее прерванную загрузку:
```bash
bash scripts/data_download.sh --datasets golos
```

Принудительно переустановить всё:
```bash
bash scripts/data_download.sh reinstall-all --sova-archive /path/to/RuDevices.tar
```

## Подсчет длительности
Длительность считается в таком порядке:
1. Колонка длительности из CSV-манифеста (если есть).
2. `soundfile`.
3. WAV-заголовок через стандартный модуль `wave`.
4. `ffprobe` как fallback.

Если длительность конкретного файла определить нельзя, файл учитывается как 0 секунд.

## Безопасность
- Для сетевых загрузок разрешены только URL-схемы `http`/`https`.
- Для сетевых запросов установлен timeout.
- В распаковке архивов есть защита от path traversal.
- Конвертация аудиоформатов не выполняется.

## Зависимости и окружение
- Python 3.12+
- Опционально: `soundfile`, `ffprobe` для более точного подсчета длительности

## Типовые проблемы
- `Unsupported URL scheme`: используйте только `http` или `https`.
- `Local archive not found`: проверьте путь в `--sova-archive`.
- Мало часов в отчете: проверьте, что архивы распакованы и аудио-файлы присутствуют.
